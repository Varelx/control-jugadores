<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Jugadores Moderno</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js para gr√°ficas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Estilos modernos -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background:#f2f2f2; margin:0; padding:0; }
header { background:#1976d2; color:white; padding:15px; text-align:center; }
.container { max-width:1200px; margin:20px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
button { padding:8px 12px; border:none; border-radius:5px; background:#1976d2; color:white; cursor:pointer; margin:2px; }
button:hover { background:#1565c0; }
input, select { padding:6px; margin:4px 0; border-radius:4px; border:1px solid #ccc; }
.card { background:white; border:1px solid #ddd; border-radius:8px; padding:15px; margin:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; }
.card .info { flex:1; }
.card .actions { text-align:right; }
.card canvas { margin-top:10px; max-width:200px; }
.tabs { margin:10px 0; }
.tabs button { background:#eee; color:#333; }
.tabs button.active { background:#1976d2; color:white; }
.stats { font-size:0.9em; color:#555; }
</style>
</head>
<body>
<header>
  <h1>üìã Control de Jugadores</h1>
</header>
<div class="container">

<!-- Registro / Login -->
<div id="authBox">
  <h2>Registro / Login Entrenadores</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button onclick="register()">Registrarse</button>
  <button onclick="login()">Iniciar sesi√≥n</button>
  <p id="authMsg"></p>
</div>

<!-- √Årea admin -->
<div>
  <h2>√Årea de Administraci√≥n</h2>
  <input type="password" id="adminPassword" placeholder="Contrase√±a maestra">
  <button onclick="showAdmin()">Acceder</button>
  <div id="adminArea" style="display:none; margin-top:10px;">
    <h3>Solicitudes pendientes</h3>
    <div id="requestsList"></div>
  </div>
</div>

<!-- Filtrar por categor√≠a -->
<div id="app" style="display:none;">
  <h2>Gesti√≥n de Jugadores</h2>
  <div class="tabs">
    <button class="tabBtn active" onclick="filterCategory('M14')">M14</button>
    <button class="tabBtn" onclick="filterCategory('M16')">M16</button>
    <button class="tabBtn" onclick="filterCategory('M18')">M18</button>
    <button class="tabBtn" onclick="filterCategory('all')">Todos</button>
  </div>

  <!-- A√±adir jugador -->
  <div>
    <input type="text" id="playerName" placeholder="Nombre completo">
    <input type="date" id="playerBirth">
    <input type="text" id="fatherName" placeholder="Nombre padre">
    <input type="tel" id="fatherPhone" placeholder="Tel√©fono padre">
    <input type="text" id="motherName" placeholder="Nombre madre">
    <input type="tel" id="motherPhone" placeholder="Tel√©fono madre">
    <select id="categorySelect">
      <option value="M14">M14</option>
      <option value="M16">M16</option>
      <option value="M18">M18</option>
    </select>
    <button onclick="addPlayer()">‚ûï A√±adir jugador</button>
  </div>

  <div id="playersContainer"></div>
</div>

<!-- Script al final para garantizar que las funciones existen -->
<script>
// Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC-DTX0x8Bebk6Z1TEkyyVD3K4jOPVSmLA",
  authDomain: "control-jugadores-64ae6.firebaseapp.com",
  databaseURL: "https://control-jugadores-64ae6-default-rtdb.firebaseio.com",
  projectId: "control-jugadores-64ae6",
  storageBucket: "control-jugadores-64ae6.firebasestorage.app",
  messagingSenderId: "345003884874",
  appId: "1:345003884874:web:51308a576a636b5a9741b3",
  measurementId: "G-1RR2CLEPL1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const MASTER_PASSWORD = 'TU_CONTRASE√ëA_MAESTRA';
let currentCategory = 'all';

// Funciones globales
function register(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password).then(user=>{
    db.ref('users/'+user.user.uid).set({email:email,status:'pendiente'});
    document.getElementById('authMsg').innerText='Registrado, pendiente de aprobaci√≥n';
  }).catch(e=>document.getElementById('authMsg').innerText=e.message);
}

function login(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(e=>document.getElementById('authMsg').innerText=e.message);
}

auth.onAuthStateChanged(user=>{
  if(user){
    db.ref('users/'+user.uid+'/status').once('value',snap=>{
      if(snap.val()==='aprobado'){
        document.getElementById('authBox').style.display='none';
        document.getElementById('app').style.display='block';
        loadPlayers();
      }
    });
  }
});

function showAdmin(){
  const pass = document.getElementById('adminPassword').value;
  if(pass!==MASTER_PASSWORD){alert('Contrase√±a incorrecta'); return;}
  document.getElementById('adminArea').style.display='block';
  loadRequests();
}

function loadRequests(){
  const container = document.getElementById('requestsList');
  db.ref('users').on('value',snap=>{
    container.innerHTML='';
    snap.forEach(child=>{
      const u = child.val();
      if(u.status==='pendiente'){
        const div = document.createElement('div');
        div.innerHTML=`${u.email} <button onclick="approveUser('${child.key}')">Aprobar</button>`;
        container.appendChild(div);
      }
    });
  });
}

function approveUser(uid){
  db.ref('users/'+uid+'/status').set('aprobado');
}

function addPlayer(){
  const name = document.getElementById('playerName').value;
  const birth = document.getElementById('playerBirth').value;
  const fatherName = document.getElementById('fatherName').value;
  const fatherPhone = document.getElementById('fatherPhone').value;
  const motherName = document.getElementById('motherName').value;
  const motherPhone = document.getElementById('motherPhone').value;
  const category = document.getElementById('categorySelect').value;
  if(!name) return alert('Nombre requerido');
  const ref = db.ref('players').push();
  ref.set({name,birth,fatherName,fatherPhone,motherName,motherPhone,category,attendance:{}});
  ['playerName','playerBirth','fatherName','fatherPhone','motherName','motherPhone'].forEach(id=>document.getElementById(id).value='');
}

function loadPlayers(){
  const container = document.getElementById('playersContainer');
  db.ref('players').on('value',snap=>{
    container.innerHTML='';
    snap.forEach(child=>{
      const p = child.val();
      const id = child.key;
      if(currentCategory==='all' || p.category===currentCategory){
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML=`
          <div class='info'>
            <strong>${p.name}</strong> (${p.category})<br>
            Nacimiento: <span>${p.birth||''}</span><br>
            Padre: ${p.fatherName} (${p.fatherPhone})<br>
            Madre: ${p.motherName} (${p.motherPhone})<br>
            Asistencias: <span id='att_${id}'>0</span>
            <canvas id='chart_${id}'></canvas>
          </div>
          <div class='actions'>
            <button onclick='editPlayer("${id}")'>‚úèÔ∏è Editar</button>
          </div>`;
        container.appendChild(div);
        updateAttendance(id);
      }
    });
  });
}

function editPlayer(id){
  const playerRef = db.ref('players/'+id);
  playerRef.once('value',snap=>{
    const p = snap.val();
    const newName = prompt('Nombre',p.name); if(newName) playerRef.update({name:newName});
    const newBirth = prompt('Fecha de nacimiento',p.birth); if(newBirth) playerRef.update({birth:newBirth});
    const newFather = prompt('Padre',p.fatherName); if(newFather) playerRef.update({fatherName:newFather});
    const newFatherPhone = prompt('Tel√©fono padre',p.fatherPhone); if(newFatherPhone) playerRef.update({fatherPhone:newFatherPhone});
    const newMother = prompt('Madre',p.motherName); if(newMother) playerRef.update({motherName:newMother});
    const newMotherPhone = prompt('Tel√©fono madre',p.motherPhone); if(newMotherPhone) playerRef.update({motherPhone:newMotherPhone});
  });
}

function updateAttendance(playerId){
  db.ref('players/'+playerId+'/attendance').on('value',snap=>{
    const att = snap.val() || {};
    const total = Object.keys(att).length;
    const count = Object.values(att).filter(v=>v===true).length;
    document.getElementById('att_'+playerId).innerText = `${count}/${total}`;

    // Chart
    const ctx = document.getElementById('chart_'+playerId).getContext('2d');
    new Chart(ctx, { type:'bar', data:{labels:['Asistencias','Faltas'], datasets:[{label:'Asistencias',data:[count,total-count],backgroundColor:['#1976d2','#ccc']}]}, options:{responsive:true,plugins:{legend:{display:false}}} });
  });
}

function filterCategory(cat){
  currentCategory=cat;
  document.querySelectorAll('.tabBtn').forEach(btn=>btn.classList.remove('active'));
  Array.from(document.querySelectorAll('.tabBtn')).find(b=>b.textContent===cat || cat==='all').classList.add('active');
  loadPlayers();
}
</script>
</body>
</html>
